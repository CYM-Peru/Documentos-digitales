// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["invoice_system"]
}

enum UserRole {
  SUPER_ADMIN
  ORG_ADMIN
  USER_L1      // Usuario b√°sico: solo planillas movilidad y gastos reparables
  USER_L2      // Usuario intermedio: rendiciones, cajas chicas, planillas
  USER_L3      // Asesor L3: planillas con selecci√≥n de destino (rendici√≥n o caja chica)
  VERIFICADOR  // Asocia planillas aprobadas a caja chica (filtrado por CodLocal)
  APROBADOR    // Aprueba planillas (Amanda Arroyo)
  STAFF        // Ve todo pero no aprueba

  @@schema("invoice_system")
}

enum InvoiceStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@schema("invoice_system")
}

enum OperationType {
  RENDICION
  CAJA_CHICA
  PLANILLA_MOVILIDAD
  GASTO_REPARABLE

  @@schema("invoice_system")
}

enum AprobacionEstado {
  PENDIENTE_APROBACION
  APROBADA
  RECHAZADA

  @@schema("invoice_system")
}

enum OCRProvider {
  AWS_TEXTRACT
  GOOGLE_VISION
  AZURE_COMPUTER_VISION
  GEMINI_VISION

  @@schema("invoice_system")
}

model Sede {
  id        String   @id @default(cuid())
  nombre    String   @unique
  codigo    String   @unique
  codLocal  String?  // CodLocal para SQL Server (1=Arica, 11=Lur√≠n, etc.)
  activa    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]

  @@map("sedes")
  @@schema("invoice_system")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active    Boolean  @default(true)

  users    User[]
  invoices Invoice[]
  settings OrganizationSettings?
  planillasMovilidad MovilidadPlanilla[]
  gastosReparables GastoReparablePlanilla[]

  @@map("organizations")
  @@schema("invoice_system")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  username       String?  @unique // Usuario para login (ej: AARROYO) - case insensitive en auth
  name           String?
  phone          String?  // N√∫mero de WhatsApp para notificaciones (formato: 51999999999)
  passwordHash   String?
  role           UserRole @default(USER_L1)
  organizationId String
  sedeId         String?  // Sede del usuario (Arica, Lur√≠n, etc.)
  modulosPermitidos String[] @default(["PLANILLAS"]) // M√≥dulos que puede ver: PLANILLAS, RENDICIONES, CAJAS_CHICAS
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  active         Boolean  @default(true)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sede         Sede?        @relation(fields: [sedeId], references: [id])
  invoices     Invoice[]
  planillasCreadas MovilidadPlanilla[]
  planillasAprobadas MovilidadPlanilla[] @relation("AprobadorPlanillas")
  gastosReparablesCreados GastoReparablePlanilla[]
  gastosReparablesAprobados GastoReparablePlanilla[] @relation("AprobadorGastosReparables")

  @@index([organizationId])
  @@index([sedeId])
  @@map("users")
  @@schema("invoice_system")
}

model OrganizationSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique

  // AWS Textract Settings (encrypted)
  awsAccessKey      String?
  awsSecretKey      String? // Encrypted
  awsRegion         String?  @default("us-east-1")

  // Google Settings (encrypted)
  googleServiceAccount String? // Encrypted JSON
  googleSheetsId       String?
  googleDriveFolderId  String?

  // Google Gemini AI (encrypted)
  geminiApiKey String? // Encrypted
  geminiModel  String? @default("gemini-2.0-flash-exp")
  geminiPrompt String? @db.Text // Custom prompt for invoice analysis

  // SUNAT API Settings (encrypted)
  sunatClientId     String? // Encrypted - Client ID de SUNAT
  sunatClientSecret String? // Encrypted - Client Secret de SUNAT
  sunatRuc          String? // RUC de la empresa que consulta
  sunatEnabled      Boolean @default(false) // Activar/desactivar validaci√≥n SUNAT

  // n8n Integration
  n8nWebhookUrl String?

  // SQL Server Integration (encrypted)
  sqlServerEnabled Boolean @default(false) // Activar/desactivar exportaci√≥n a SQL Server
  sqlServerHost    String? // Encrypted - Servidor SQL Server (localhost o IP)
  sqlServerPort    Int?    @default(1433)
  sqlServerDatabase String? // Nombre de la base de datos
  sqlServerUser    String? // Encrypted - Usuario SQL Server
  sqlServerPassword String? // Encrypted - Contrase√±a SQL Server
  sqlServerEncrypt Boolean @default(false) // SSL/TLS: false para SQL Server local, true para Azure SQL
  sqlServerTrustCert Boolean @default(true) // Trust server certificate: true para SQL Server local

  // OCR Provider
  ocrProvider OCRProvider @default(GEMINI_VISION)

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SISTEMA DE DETECCI√ìN AUTOM√ÅTICA DE FACTURAS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // Monitor de Email - Detecci√≥n autom√°tica de facturas en correo
  emailMonitorEnabled Boolean @default(false) // Activar/desactivar monitoreo de email
  emailMonitorType    String? @default("imap") // "imap" | "oauth2_gmail" | "oauth2_outlook"
  emailHost           String? // Encrypted - Servidor IMAP (imap.gmail.com, outlook.office365.com)
  emailPort           Int?    @default(993) // Puerto IMAP (993 con SSL, 143 sin SSL)
  emailUsername       String? // Encrypted - Email para monitorear
  emailPassword       String? // Encrypted - Contrase√±a o App Password
  emailUseSsl         Boolean @default(true) // Usar SSL/TLS
  emailFolder         String? @default("INBOX") // Carpeta a monitorear
  emailCheckInterval  Int?    @default(15) // Intervalo de revisi√≥n en minutos (15, 30, 60)

  // Filtros de Email - Configuraci√≥n de detecci√≥n
  emailSubjectKeywords String? @default("factura,comprobante,invoice,boleta,nota de cr√©dito") // Palabras clave en asunto (separadas por coma)
  emailFromWhitelist   String? // Emails permitidos (separados por coma) - opcional
  emailFromBlacklist   String? // Emails bloqueados (separados por coma) - opcional
  emailAutoProcess     Boolean @default(true) // Procesar autom√°ticamente XMLs detectados
  emailDeleteAfter     Boolean @default(false) // Eliminar email despu√©s de procesar
  emailMarkAsRead      Boolean @default(true) // Marcar email como le√≠do despu√©s de procesar

  // OAuth2 Credentials (para Gmail/Outlook) - Encrypted
  emailOauth2ClientId     String? // Encrypted - OAuth2 Client ID
  emailOauth2ClientSecret String? // Encrypted - OAuth2 Client Secret
  emailOauth2RefreshToken String? // Encrypted - OAuth2 Refresh Token
  emailOauth2AccessToken  String? // Encrypted - OAuth2 Access Token (renovable)
  emailOauth2TokenExpiry  DateTime? // Expiraci√≥n del Access Token

  // Consulta Autom√°tica SUNAT - Detecci√≥n de comprobantes recibidos
  sunatAutoCheckEnabled   Boolean @default(false) // Activar consulta autom√°tica de comprobantes
  sunatAutoCheckInterval  Int?    @default(1440) // Intervalo en minutos (1440 = 1 d√≠a)
  sunatAutoCheckLastRun   DateTime? // √öltima ejecuci√≥n de consulta
  sunatCheckDaysBack      Int?    @default(7) // D√≠as hacia atr√°s para consultar (7, 15, 30)

  // Sistema de Alertas - Notificaciones autom√°ticas
  alertsEnabled           Boolean @default(true) // Activar sistema de alertas
  alertMissingXmlDays     Int?    @default(3) // D√≠as antes de alertar por XML faltante
  alertAutoEmailProvider  Boolean @default(true) // Enviar email autom√°tico a proveedor solicitando XML
  alertEmailTemplate      String? @db.Text // Template personalizado para emails a proveedores
  alertNotifyUsers        String? // IDs de usuarios a notificar (separados por coma)
  alertSlackWebhook       String? // Encrypted - Webhook de Slack para alertas
  alertTeamsWebhook       String? // Encrypted - Webhook de Microsoft Teams

  // Configuraci√≥n de Emails Autom√°ticos a Proveedores
  providerEmailEnabled    Boolean @default(false) // Enviar emails autom√°ticos a proveedores
  providerEmailFrom       String? // Email remitente (tu empresa)
  providerEmailSubject    String? @default("Solicitud de XML - Factura Electr√≥nica") // Asunto del email
  providerEmailSmtpHost   String? // Encrypted - Servidor SMTP (smtp.gmail.com)
  providerEmailSmtpPort   Int?    @default(587) // Puerto SMTP
  providerEmailSmtpUser   String? // Encrypted - Usuario SMTP
  providerEmailSmtpPass   String? // Encrypted - Contrase√±a SMTP
  providerEmailSmtpSsl    Boolean @default(true) // Usar SSL/TLS

  // Notifications
  emailNotifications Boolean @default(true)
  webhookNotifications Boolean @default(false)

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // WHATSAPP NOTIFICATIONS - Evolution API Integration
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  whatsappEnabled         Boolean   @default(false) // Activar/desactivar notificaciones WhatsApp
  whatsappInstanceName    String?   @default("azaleia-planillas") // Nombre de la instancia en Evolution API
  whatsappInstanceId      String?   // ID de la instancia una vez conectada
  whatsappConnected       Boolean   @default(false) // Estado de conexi√≥n
  whatsappPhoneNumber     String?   // N√∫mero conectado (formato: 51999999999)
  whatsappConnectedAt     DateTime? // Fecha de conexi√≥n
  whatsappQrCode          String?   @db.Text // √öltimo QR code generado
  whatsappApiKey          String?   @default("B6D711FCDE4D4FD5936544120E713976") // API Key de Evolution API
  whatsappApiUrl          String?   @default("http://localhost:8080") // URL de Evolution API

  // Configuraci√≥n de mensajes
  whatsappNotifyPlanillaCreated  Boolean @default(true) // Notificar cuando se crea planilla
  whatsappNotifyPlanillaApproved Boolean @default(true) // Notificar cuando se aprueba planilla
  whatsappNotifyPlanillaRejected Boolean @default(true) // Notificar cuando se rechaza planilla

  // N√∫meros de WhatsApp para notificaciones (formato: 51999999999, separados por coma)
  whatsappApproverNumbers String? // N√∫meros de aprobadores (ej: "51968801771,51952393110")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
  @@schema("invoice_system")
}

model Invoice {
  id             String        @id @default(cuid())
  organizationId String
  userId         String

  // Image data
  imageUrl       String
  thumbnailUrl   String? // Thumbnail peque√±o para carga r√°pida
  imageName      String
  imageSize      Int?

  // OCR data
  ocrData        Json?
  rawOcrResponse Json?

  // Extracted fields
  vendorName     String?
  invoiceNumber  String?
  invoiceDate    DateTime?
  totalAmount    Float?
  currency       String?
  taxAmount      Float?

  // Campos espec√≠ficos para facturas peruanas (SUNAT)
  documentType           String? // Tipo de documento SUNAT (FACTURA, BOLETA, NOTA DE CR√âDITO, etc.)
  documentTypeCode       String? // C√≥digo SUNAT Cat√°logo 01 (01, 03, 07, 08, 09, etc.)
  rucEmisor              String? // RUC del emisor (11 d√≠gitos)
  razonSocialEmisor      String? // Raz√≥n social del emisor
  domicilioFiscalEmisor  String? // Domicilio fiscal del emisor
  rucReceptor            String? // RUC del cliente/receptor
  dniReceptor            String? // DNI del cliente/receptor
  razonSocialReceptor    String? // Nombre/Raz√≥n social del receptor
  serieNumero            String? // Serie y n√∫mero (ej: F001-00012345)
  subtotal               Float?  // Valor de venta sin IGV
  igvTasa                Float?  // Tasa de IGV (ej: 18.0 o 10.0)
  igvMonto               Float?  // Monto del IGV

  // C√≥digo QR (para detecci√≥n de duplicados y validaci√≥n 100% precisa)
  qrCode                 String?  // Contenido del c√≥digo QR extra√≠do (texto completo)
  qrCodeHash             String?  // Hash del QR para b√∫squeda r√°pida de duplicados

  // Detecci√≥n de duplicados
  isDuplicate            Boolean  @default(false)
  duplicateOfId          String?  // ID de la factura original si es duplicado
  duplicateDetectionMethod String? // "qr" | "ruc_serie_numero" | "manual"

  // Verificaci√≥n SUNAT
  sunatVerified          Boolean? // true=Verificado, false=No v√°lido, null=No verificado
  sunatEstadoCp          String?  // 0=No existe, 1=V√°lido, 2=Anulado, 3=Rechazado
  sunatEstadoRuc         String?  // 00=Activo, 01=Baja provisional, 02=Baja definitiva
  sunatObservaciones     Json?    // Observaciones de SUNAT
  sunatVerifiedAt        DateTime? // Fecha de verificaci√≥n
  sunatRetries           Int?     @default(0) // N√∫mero de reintentos de validaci√≥n

  // Status
  status         InvoiceStatus @default(PENDING)
  errorMessage   String?

  // Integrations
  googleSheetsRowId Int?
  n8nExecutionId    String?

  // Gesti√≥n y Rendici√≥n
  nroRendicion      String? // N√∫mero de rendici√≥n (opcional, con alerta si vac√≠o)
  codLocal          String? // C√≥digo de local para cajas chicas
  tipoOperacion     OperationType @default(RENDICION) // Tipo: RENDICION o CAJA_CHICA

  // Campos adicionales OCR y edici√≥n
  anotacionManuscrita String? // Anotaci√≥n manuscrita detectada por OCR
  conceptoGasto       String? // Concepto del gasto extra√≠do o editado
  glosaEditada        String? // Glosa editada por el usuario
  resumenItems        String? // Resumen de items de la factura
  observacion         String? // Observaciones adicionales

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([qrCodeHash]) // Para b√∫squeda r√°pida de duplicados por QR
  @@index([rucEmisor, serieNumero]) // Para b√∫squeda de duplicados por RUC+Serie+N√∫mero
  @@index([isDuplicate])
  @@map("invoices")
  @@schema("invoice_system")
}

model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  orgId     String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  expiresAt DateTime?

  @@index([key])
  @@index([orgId])
  @@map("api_keys")
  @@schema("invoice_system")
}

model MovilidadPlanilla {
  id             String   @id @default(cuid())
  organizationId String
  userId         String

  // Datos de la planilla
  nroPlanilla       String?
  razonSocial       String?
  ruc               String?
  periodo           String?
  fechaEmision      DateTime?

  // Datos del trabajador
  nombresApellidos  String
  cargo             String
  dni               String
  centroCosto       String?

  // Totales
  totalViaje        Float    @default(0)
  totalDia          Float    @default(0)
  totalGeneral      Float    @default(0)

  // Tipo de operaci√≥n y n√∫mero asignado
  tipoOperacion     OperationType?
  nroRendicion      String?
  nroCajaChica      String?

  // Estado de aprobaci√≥n
  estadoAprobacion  AprobacionEstado @default(PENDIENTE_APROBACION)
  aprobadoPorId     String?
  aprobadoEn        DateTime?
  comentariosAprobacion String?
  camposConError    Json?        // üÜï Array de campos marcados como err√≥neos en rechazo
  aplicadaEn        DateTime?  // üÜï Fecha en que se aplic√≥ a rendici√≥n/caja chica

  // Imagen escaneada (si aplica)
  imageUrl          String?

  // Metadatos
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  aprobadoPor  User?        @relation("AprobadorPlanillas", fields: [aprobadoPorId], references: [id])
  gastos       MovilidadGasto[]

  @@index([organizationId])
  @@index([userId])
  @@index([estadoAprobacion])
  @@index([aprobadoPorId])
  @@index([createdAt])
  @@map("movilidad_planillas")
  @@schema("invoice_system")
}

model MovilidadGasto {
  id          Int      @id @default(autoincrement())
  planillaId  String

  // Fecha del gasto
  dia         Int?
  mes         Int?
  anio        Int?
  fechaGasto  DateTime?

  // Descripci√≥n
  motivo      String?
  origen      String?
  destino     String?

  // Montos
  montoViaje  Float    @default(0)
  montoDia    Float    @default(0)

  // Metadatos
  createdAt   DateTime @default(now())

  // Relaci√≥n
  planilla    MovilidadPlanilla @relation(fields: [planillaId], references: [id], onDelete: Cascade)

  @@index([planillaId])
  @@map("movilidad_gastos")
  @@schema("invoice_system")
}

model NotificationSettings {
  id               String    @id @default(cuid())
  notificationTime String    @default("09:00") // Hora en formato HH:MM
  enabled          Boolean   @default(true)
  lastSentAt       DateTime?

  // Configuraci√≥n SMTP para emails
  smtpHost         String?   // smtp.gmail.com, smtp.office365.com, etc.
  smtpPort         Int?      @default(587)
  smtpUser         String?   // Email del remitente
  smtpPass         String?   // Contrase√±a o App Password
  smtpSecure       Boolean   @default(false) // true para puerto 465
  emailFrom        String?   // Nombre del remitente "Sistema Cockpit <noreply@...>"

  // Emails de aprobadores (separados por coma)
  approverEmails   String?   // "aprobador1@empresa.com,aprobador2@empresa.com"

  // Tipos de notificaci√≥n habilitados
  notifyOnNewPlanilla    Boolean @default(true)
  notifyOnApproval       Boolean @default(true)
  notifyOnRejection      Boolean @default(true)
  notifyDailySummary     Boolean @default(true)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("notification_settings")
  @@schema("invoice_system")
}

// Tabla para correlativos de planillas de movilidad
// Garantiza n√∫meros √∫nicos incluso con m√∫ltiples usuarios simult√°neos
model PlanillaCorrelativo {
  id            String   @id @default(cuid())
  serie         String   @unique // A√±o: "2025", "2026", etc.
  ultimoNumero  Int      @default(0) // √öltimo n√∫mero usado
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("planilla_correlativos")
  @@schema("invoice_system")
}

// ========== GASTOS REPARABLES ==========

model GastoReparablePlanilla {
  id                String         @id @default(cuid())
  organizationId    String
  userId            String

  // Datos de la planilla
  nroPlanilla       String?
  razonSocial       String?        @default("CALZADOS AZALEIA PERU S.A.")
  ruc               String?        @default("20374412524")
  periodo           String?
  fechaEmision      DateTime?
  nombresApellidos  String
  cargo             String
  dni               String
  centroCosto       String?

  // Totales
  totalGeneral      Float          @default(0)

  // Destino
  tipoOperacion     OperationType?
  nroRendicion      String?
  nroCajaChica      String?

  // Aprobaci√≥n
  estadoAprobacion  AprobacionEstado @default(PENDIENTE_APROBACION)
  aprobadoPorId     String?
  aprobadoEn        DateTime?
  comentariosAprobacion String?
  camposConError    Json?

  // Imagen
  imageUrl          String?

  // Metadatos
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  organization      Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  aprobadoPor       User?          @relation("AprobadorGastosReparables", fields: [aprobadoPorId], references: [id])
  items             GastoReparableItem[]

  @@index([organizationId])
  @@index([userId])
  @@index([estadoAprobacion])
  @@index([aprobadoPorId])
  @@index([createdAt])
  @@map("gasto_reparable_planillas")
  @@schema("invoice_system")
}

model GastoReparableItem {
  id          Int      @id @default(autoincrement())
  planillaId  String

  // Fecha del gasto
  dia         Int?
  mes         Int?
  anio        Int?
  fechaGasto  DateTime?

  // Descripci√≥n
  tipoDoc     String?
  concepto    String?
  tipoGasto   String?

  // Monto
  importe     Float    @default(0)

  // Metadatos
  createdAt   DateTime @default(now())

  // Relaci√≥n
  planilla    GastoReparablePlanilla @relation(fields: [planillaId], references: [id], onDelete: Cascade)

  @@index([planillaId])
  @@map("gasto_reparable_items")
  @@schema("invoice_system")
}

model GastoReparableCorrelativo {
  id            String   @id @default(cuid())
  serie         String   @unique
  ultimoNumero  Int      @default(100000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("gasto_reparable_correlativos")
  @@schema("invoice_system")
}
