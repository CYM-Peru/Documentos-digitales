// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["invoice_system"]
}

enum UserRole {
  SUPER_ADMIN
  ORG_ADMIN
  USER
  APROBADOR

  @@schema("invoice_system")
}

enum InvoiceStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED

  @@schema("invoice_system")
}

enum OperationType {
  RENDICION
  CAJA_CHICA
  PLANILLA_MOVILIDAD

  @@schema("invoice_system")
}

enum AprobacionEstado {
  PENDIENTE_APROBACION
  APROBADA
  RECHAZADA

  @@schema("invoice_system")
}

enum OCRProvider {
  AWS_TEXTRACT
  GOOGLE_VISION
  AZURE_COMPUTER_VISION
  GEMINI_VISION

  @@schema("invoice_system")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active    Boolean  @default(true)

  users    User[]
  invoices Invoice[]
  settings OrganizationSettings?
  planillasMovilidad MovilidadPlanilla[]

  @@map("organizations")
  @@schema("invoice_system")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  phone          String?  // NÃºmero de WhatsApp para notificaciones (formato: 51999999999)
  passwordHash   String?
  role           UserRole @default(USER)
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  active         Boolean  @default(true)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  planillasCreadas MovilidadPlanilla[]
  planillasAprobadas MovilidadPlanilla[] @relation("AprobadorPlanillas")

  @@index([organizationId])
  @@map("users")
  @@schema("invoice_system")
}

model OrganizationSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique

  // AWS Textract Settings (encrypted)
  awsAccessKey      String?
  awsSecretKey      String? // Encrypted
  awsRegion         String?  @default("us-east-1")

  // Google Settings (encrypted)
  googleServiceAccount String? // Encrypted JSON
  googleSheetsId       String?
  googleDriveFolderId  String?

  // Google Gemini AI (encrypted)
  geminiApiKey String? // Encrypted
  geminiModel  String? @default("gemini-2.0-flash-exp")
  geminiPrompt String? @db.Text // Custom prompt for invoice analysis

  // SUNAT API Settings (encrypted)
  sunatClientId     String? // Encrypted - Client ID de SUNAT
  sunatClientSecret String? // Encrypted - Client Secret de SUNAT
  sunatRuc          String? // RUC de la empresa que consulta
  sunatEnabled      Boolean @default(false) // Activar/desactivar validaciÃ³n SUNAT

  // n8n Integration
  n8nWebhookUrl String?

  // SQL Server Integration (encrypted)
  sqlServerEnabled Boolean @default(false) // Activar/desactivar exportaciÃ³n a SQL Server
  sqlServerHost    String? // Encrypted - Servidor SQL Server (localhost o IP)
  sqlServerPort    Int?    @default(1433)
  sqlServerDatabase String? // Nombre de la base de datos
  sqlServerUser    String? // Encrypted - Usuario SQL Server
  sqlServerPassword String? // Encrypted - ContraseÃ±a SQL Server
  sqlServerEncrypt Boolean @default(false) // SSL/TLS: false para SQL Server local, true para Azure SQL
  sqlServerTrustCert Boolean @default(true) // Trust server certificate: true para SQL Server local

  // OCR Provider
  ocrProvider OCRProvider @default(GEMINI_VISION)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SISTEMA DE DETECCIÃ“N AUTOMÃTICA DE FACTURAS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Monitor de Email - DetecciÃ³n automÃ¡tica de facturas en correo
  emailMonitorEnabled Boolean @default(false) // Activar/desactivar monitoreo de email
  emailMonitorType    String? @default("imap") // "imap" | "oauth2_gmail" | "oauth2_outlook"
  emailHost           String? // Encrypted - Servidor IMAP (imap.gmail.com, outlook.office365.com)
  emailPort           Int?    @default(993) // Puerto IMAP (993 con SSL, 143 sin SSL)
  emailUsername       String? // Encrypted - Email para monitorear
  emailPassword       String? // Encrypted - ContraseÃ±a o App Password
  emailUseSsl         Boolean @default(true) // Usar SSL/TLS
  emailFolder         String? @default("INBOX") // Carpeta a monitorear
  emailCheckInterval  Int?    @default(15) // Intervalo de revisiÃ³n en minutos (15, 30, 60)

  // Filtros de Email - ConfiguraciÃ³n de detecciÃ³n
  emailSubjectKeywords String? @default("factura,comprobante,invoice,boleta,nota de crÃ©dito") // Palabras clave en asunto (separadas por coma)
  emailFromWhitelist   String? // Emails permitidos (separados por coma) - opcional
  emailFromBlacklist   String? // Emails bloqueados (separados por coma) - opcional
  emailAutoProcess     Boolean @default(true) // Procesar automÃ¡ticamente XMLs detectados
  emailDeleteAfter     Boolean @default(false) // Eliminar email despuÃ©s de procesar
  emailMarkAsRead      Boolean @default(true) // Marcar email como leÃ­do despuÃ©s de procesar

  // OAuth2 Credentials (para Gmail/Outlook) - Encrypted
  emailOauth2ClientId     String? // Encrypted - OAuth2 Client ID
  emailOauth2ClientSecret String? // Encrypted - OAuth2 Client Secret
  emailOauth2RefreshToken String? // Encrypted - OAuth2 Refresh Token
  emailOauth2AccessToken  String? // Encrypted - OAuth2 Access Token (renovable)
  emailOauth2TokenExpiry  DateTime? // ExpiraciÃ³n del Access Token

  // Consulta AutomÃ¡tica SUNAT - DetecciÃ³n de comprobantes recibidos
  sunatAutoCheckEnabled   Boolean @default(false) // Activar consulta automÃ¡tica de comprobantes
  sunatAutoCheckInterval  Int?    @default(1440) // Intervalo en minutos (1440 = 1 dÃ­a)
  sunatAutoCheckLastRun   DateTime? // Ãšltima ejecuciÃ³n de consulta
  sunatCheckDaysBack      Int?    @default(7) // DÃ­as hacia atrÃ¡s para consultar (7, 15, 30)

  // Sistema de Alertas - Notificaciones automÃ¡ticas
  alertsEnabled           Boolean @default(true) // Activar sistema de alertas
  alertMissingXmlDays     Int?    @default(3) // DÃ­as antes de alertar por XML faltante
  alertAutoEmailProvider  Boolean @default(true) // Enviar email automÃ¡tico a proveedor solicitando XML
  alertEmailTemplate      String? @db.Text // Template personalizado para emails a proveedores
  alertNotifyUsers        String? // IDs de usuarios a notificar (separados por coma)
  alertSlackWebhook       String? // Encrypted - Webhook de Slack para alertas
  alertTeamsWebhook       String? // Encrypted - Webhook de Microsoft Teams

  // ConfiguraciÃ³n de Emails AutomÃ¡ticos a Proveedores
  providerEmailEnabled    Boolean @default(false) // Enviar emails automÃ¡ticos a proveedores
  providerEmailFrom       String? // Email remitente (tu empresa)
  providerEmailSubject    String? @default("Solicitud de XML - Factura ElectrÃ³nica") // Asunto del email
  providerEmailSmtpHost   String? // Encrypted - Servidor SMTP (smtp.gmail.com)
  providerEmailSmtpPort   Int?    @default(587) // Puerto SMTP
  providerEmailSmtpUser   String? // Encrypted - Usuario SMTP
  providerEmailSmtpPass   String? // Encrypted - ContraseÃ±a SMTP
  providerEmailSmtpSsl    Boolean @default(true) // Usar SSL/TLS

  // Notifications
  emailNotifications Boolean @default(true)
  webhookNotifications Boolean @default(false)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // WHATSAPP NOTIFICATIONS - Evolution API Integration
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  whatsappEnabled         Boolean   @default(false) // Activar/desactivar notificaciones WhatsApp
  whatsappInstanceName    String?   @default("azaleia-planillas") // Nombre de la instancia en Evolution API
  whatsappInstanceId      String?   // ID de la instancia una vez conectada
  whatsappConnected       Boolean   @default(false) // Estado de conexiÃ³n
  whatsappPhoneNumber     String?   // NÃºmero conectado (formato: 51999999999)
  whatsappConnectedAt     DateTime? // Fecha de conexiÃ³n
  whatsappQrCode          String?   @db.Text // Ãšltimo QR code generado
  whatsappApiKey          String?   @default("B6D711FCDE4D4FD5936544120E713976") // API Key de Evolution API
  whatsappApiUrl          String?   @default("http://localhost:8080") // URL de Evolution API

  // ConfiguraciÃ³n de mensajes
  whatsappNotifyPlanillaCreated  Boolean @default(true) // Notificar cuando se crea planilla
  whatsappNotifyPlanillaApproved Boolean @default(true) // Notificar cuando se aprueba planilla
  whatsappNotifyPlanillaRejected Boolean @default(true) // Notificar cuando se rechaza planilla

  // NÃºmeros de WhatsApp para notificaciones (formato: 51999999999, separados por coma)
  whatsappApproverNumbers String? // NÃºmeros de aprobadores (ej: "51968801771,51952393110")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
  @@schema("invoice_system")
}

model Invoice {
  id             String        @id @default(cuid())
  organizationId String
  userId         String

  // Image data
  imageUrl       String
  thumbnailUrl   String? // Thumbnail pequeÃ±o para carga rÃ¡pida
  imageName      String
  imageSize      Int?

  // OCR data
  ocrData        Json?
  rawOcrResponse Json?

  // Extracted fields
  vendorName     String?
  invoiceNumber  String?
  invoiceDate    DateTime?
  totalAmount    Float?
  currency       String?
  taxAmount      Float?

  // Campos especÃ­ficos para facturas peruanas (SUNAT)
  documentType           String? // Tipo de documento SUNAT (FACTURA, BOLETA, NOTA DE CRÃ‰DITO, etc.)
  documentTypeCode       String? // CÃ³digo SUNAT CatÃ¡logo 01 (01, 03, 07, 08, 09, etc.)
  rucEmisor              String? // RUC del emisor (11 dÃ­gitos)
  razonSocialEmisor      String? // RazÃ³n social del emisor
  domicilioFiscalEmisor  String? // Domicilio fiscal del emisor
  rucReceptor            String? // RUC del cliente/receptor
  dniReceptor            String? // DNI del cliente/receptor
  razonSocialReceptor    String? // Nombre/RazÃ³n social del receptor
  serieNumero            String? // Serie y nÃºmero (ej: F001-00012345)
  subtotal               Float?  // Valor de venta sin IGV
  igvTasa                Float?  // Tasa de IGV (ej: 18.0 o 10.0)
  igvMonto               Float?  // Monto del IGV

  // CÃ³digo QR (para detecciÃ³n de duplicados y validaciÃ³n 100% precisa)
  qrCode                 String?  // Contenido del cÃ³digo QR extraÃ­do (texto completo)
  qrCodeHash             String?  // Hash del QR para bÃºsqueda rÃ¡pida de duplicados

  // DetecciÃ³n de duplicados
  isDuplicate            Boolean  @default(false)
  duplicateOfId          String?  // ID de la factura original si es duplicado
  duplicateDetectionMethod String? // "qr" | "ruc_serie_numero" | "manual"

  // VerificaciÃ³n SUNAT
  sunatVerified          Boolean? // true=Verificado, false=No vÃ¡lido, null=No verificado
  sunatEstadoCp          String?  // 0=No existe, 1=VÃ¡lido, 2=Anulado, 3=Rechazado
  sunatEstadoRuc         String?  // 00=Activo, 01=Baja provisional, 02=Baja definitiva
  sunatObservaciones     Json?    // Observaciones de SUNAT
  sunatVerifiedAt        DateTime? // Fecha de verificaciÃ³n
  sunatRetries           Int?     @default(0) // NÃºmero de reintentos de validaciÃ³n

  // Status
  status         InvoiceStatus @default(PENDING)
  errorMessage   String?

  // Integrations
  googleSheetsRowId Int?
  n8nExecutionId    String?

  // GestiÃ³n y RendiciÃ³n
  nroRendicion      String? // NÃºmero de rendiciÃ³n (opcional, con alerta si vacÃ­o)
  tipoOperacion     OperationType @default(RENDICION) // Tipo: RENDICION o CAJA_CHICA

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([qrCodeHash]) // Para bÃºsqueda rÃ¡pida de duplicados por QR
  @@index([rucEmisor, serieNumero]) // Para bÃºsqueda de duplicados por RUC+Serie+NÃºmero
  @@index([isDuplicate])
  @@map("invoices")
  @@schema("invoice_system")
}

model ApiKey {
  id        String   @id @default(cuid())
  key       String   @unique
  name      String
  orgId     String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  expiresAt DateTime?

  @@index([key])
  @@index([orgId])
  @@map("api_keys")
  @@schema("invoice_system")
}

model MovilidadPlanilla {
  id             String   @id @default(cuid())
  organizationId String
  userId         String

  // Datos de la planilla
  nroPlanilla       String?
  razonSocial       String?
  ruc               String?
  periodo           String?
  fechaEmision      DateTime?

  // Datos del trabajador
  nombresApellidos  String
  cargo             String
  dni               String
  centroCosto       String?

  // Totales
  totalViaje        Float    @default(0)
  totalDia          Float    @default(0)
  totalGeneral      Float    @default(0)

  // Tipo de operaciÃ³n y nÃºmero asignado
  tipoOperacion     OperationType?
  nroRendicion      String?
  nroCajaChica      String?

  // Estado de aprobaciÃ³n
  estadoAprobacion  AprobacionEstado @default(PENDIENTE_APROBACION)
  aprobadoPorId     String?
  aprobadoEn        DateTime?
  comentariosAprobacion String?
  aplicadaEn        DateTime?  // ğŸ†• Fecha en que se aplicÃ³ a rendiciÃ³n/caja chica

  // Imagen escaneada (si aplica)
  imageUrl          String?

  // Metadatos
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relaciones
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  aprobadoPor  User?        @relation("AprobadorPlanillas", fields: [aprobadoPorId], references: [id])
  gastos       MovilidadGasto[]

  @@index([organizationId])
  @@index([userId])
  @@index([estadoAprobacion])
  @@index([aprobadoPorId])
  @@index([createdAt])
  @@map("movilidad_planillas")
  @@schema("invoice_system")
}

model MovilidadGasto {
  id          Int      @id @default(autoincrement())
  planillaId  String

  // Fecha del gasto
  dia         Int?
  mes         Int?
  anio        Int?
  fechaGasto  DateTime?

  // DescripciÃ³n
  motivo      String?
  origen      String?
  destino     String?

  // Montos
  montoViaje  Float    @default(0)
  montoDia    Float    @default(0)

  // Metadatos
  createdAt   DateTime @default(now())

  // RelaciÃ³n
  planilla    MovilidadPlanilla @relation(fields: [planillaId], references: [id], onDelete: Cascade)

  @@index([planillaId])
  @@map("movilidad_gastos")
  @@schema("invoice_system")
}
